import type { TripJournal, TripSummary, TripSettings } from '../types';
import { showToast } from './toast';

/**
 * Export the trip journal as a downloadable HTML file.
 */
export function exportJournalAsHTML(journal: TripJournal, summary: TripSummary): void {
  const journalHTML = `
<!DOCTYPE html>
<html>
<head>
  <title>${journal.metadata.title}</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
    h1 { color: #2563eb; }
    .stop { border-left: 3px solid #10b981; padding-left: 15px; margin: 20px 0; }
    .highlight { background: #fef3c7; padding: 10px; border-radius: 8px; }
    .rating { color: #f59e0b; }
  </style>
</head>
<body>
  <h1>üöó ${journal.metadata.title}</h1>
  <p><strong>Distance:</strong> ${journal.tripSummary.totalDistanceKm.toFixed(1)} km |
     <strong>Duration:</strong> ${(journal.tripSummary.totalDurationMinutes / 60).toFixed(1)} hours</p>
  <p><strong>Travelers:</strong> ${journal.metadata.travelers?.join(', ') || 'Unknown'}</p>

  <h2>Journey Highlights</h2>
  ${journal.entries.map(e => {
    const stop = summary.segments[e.segmentIndex]?.to;
    const photosHTML = e.photos.length > 0
      ? `<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px; margin: 15px 0;">
          ${e.photos.map(p => `
            <div>
              <img src="${p.dataUrl}" alt="${p.caption || 'Photo'}" style="width: 100%; height: 150px; object-fit: cover; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);" />
              ${p.caption ? `<p style="font-size: 12px; color: #6b7280; margin-top: 4px; text-align: center;">${p.caption}</p>` : ''}
            </div>
          `).join('')}
         </div>`
      : '';

    return `
    <div class="stop ${e.isHighlight ? 'highlight' : ''}">
      <h3>${stop?.name || 'Unknown'}</h3>
      ${e.rating ? `<div class="rating">${'‚≠ê'.repeat(e.rating)}</div>` : ''}
      ${photosHTML}
      ${e.notes ? `<p>${e.notes}</p>` : ''}
      ${e.isHighlight ? `<p><strong>‚ú® ${e.highlightReason}</strong></p>` : ''}
      <p><em>Status: ${e.status}</em></p>
    </div>`;
  }).join('')}

  ${journal.quickCaptures.length > 0 ? `
  <h2>üìç Memories Along the Way</h2>
  ${journal.quickCaptures.map(qc => {
    const mapsLink = qc.gpsCoords
      ? `https://www.google.com/maps?q=${qc.gpsCoords.lat},${qc.gpsCoords.lng}`
      : qc.photo?.location && (qc.photo.location.lat !== 0 || qc.photo.location.lng !== 0)
        ? `https://www.google.com/maps?q=${qc.photo.location.lat},${qc.photo.location.lng}`
        : null;
    return `
    <div style="border-left: 3px solid #a855f7; padding-left: 15px; margin: 15px 0;">
      <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
        <strong>${qc.autoTaggedLocation || 'Quick Memory'}</strong>
        ${qc.category ? `<span style="font-size: 11px; background: #f3e8ff; color: #7c3aed; padding: 2px 6px; border-radius: 9999px;">${qc.category}</span>` : ''}
        ${mapsLink ? `<a href="${mapsLink}" style="font-size: 11px; color: #2563eb;">üìç View on Maps</a>` : ''}
      </div>
      ${qc.photo ? `<img src="${qc.photo.dataUrl}" alt="${qc.photo.caption || 'Memory'}" style="width: 100%; max-width: 400px; height: 200px; object-fit: cover; border-radius: 8px; margin-bottom: 6px;" />` : ''}
      ${qc.photo?.caption ? `<p style="margin: 4px 0; color: #374151;">${qc.photo.caption}</p>` : ''}
      ${qc.gpsCoords ? `<p style="font-size: 11px; color: #9ca3af;">GPS: ${qc.gpsCoords.lat.toFixed(5)}, ${qc.gpsCoords.lng.toFixed(5)}</p>` : ''}
    </div>`;
  }).join('')}
  ` : ''}

  <h2>Trip Statistics</h2>
  <ul>
    <li>Total Stops: ${journal.stats.stopsVisited + journal.stats.stopsSkipped}</li>
    <li>Stops Visited: ${journal.stats.stopsVisited}</li>
    <li>Photos Captured: ${journal.stats.photosCount}</li>
    <li>Highlights: ${journal.stats.highlightsCount}</li>
  </ul>

  <p style="text-align: center; color: #6b7280; margin-top: 40px;">
    Generated by My Experience Engine on ${new Date().toLocaleDateString()}
  </p>
</body>
</html>`;

  const blob = new Blob([journalHTML], { type: 'text/html' });
  const url = URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.href = url;
  link.download = `roadtrip-journal-${journal.metadata.title.replace(/\s+/g, '-').toLowerCase()}.html`;
  link.click();
  URL.revokeObjectURL(url);

  showToast({
    message: 'Journal exported! Open the HTML file and print to PDF (Ctrl+P)',
    type: 'success',
    duration: 4000,
  });
}

/**
 * Export the trip as a loadable JSON template that others can import.
 */
export function exportJournalAsTemplate(journal: TripJournal, summary: TripSummary, settings: TripSettings): void {
  const template = {
    type: 'roadtrip-template',
    version: '1.0',
    createdAt: new Date().toISOString(),
    author: journal.metadata.travelers?.[0] || 'Anonymous',

    trip: {
      title: journal.metadata.title,
      description: journal.metadata.description || 'Follow this roadtrip route!',
      tags: journal.metadata.tags,
      durationDays: journal.tripSummary.days?.length || 1,
      totalDistanceKm: journal.tripSummary.totalDistanceKm,
      totalDurationHours: (journal.tripSummary.totalDurationMinutes / 60).toFixed(1),
    },

    budget: {
      profile: settings.budget.profile,
      totalSpent: journal.stats.totalActualSpent,
      perPerson: journal.stats.totalActualSpent / settings.numTravelers,
      breakdown: {
        fuel: journal.tripSummary.totalFuelCost,
        accommodation: journal.stats.totalActualSpent * 0.4, // estimate
        food: journal.stats.totalActualSpent * 0.3, // estimate
        misc: journal.stats.totalActualSpent * 0.3, // estimate
      },
    },

    route: {
      origin: summary.segments[0]?.from,
      destination: summary.segments[summary.segments.length - 1]?.to,
      waypoints: summary.segments
        .map(s => s.to)
        .filter((loc, idx, arr) => arr.findIndex(l => l.name === loc.name) === idx),
    },

    recommendations: journal.entries.map(e => {
      const stop = summary.segments[e.segmentIndex]?.to;
      return {
        location: stop?.name,
        lat: stop?.lat,
        lng: stop?.lng,
        rating: e.rating,
        notes: e.notes,
        isHighlight: e.isHighlight,
        highlightReason: e.highlightReason,
        wouldStayAgain: e.rating && e.rating >= 4,
        tips: e.notes,
      };
    }).filter(r => r.rating || r.isHighlight),

    // Include settings & vehicle so the plan can be fully loaded
    settings: {
      units: settings.units,
      currency: settings.currency,
      maxDriveHours: settings.maxDriveHours,
      numTravelers: settings.numTravelers,
      numDrivers: settings.numDrivers,
      isRoundTrip: settings.isRoundTrip,
      avoidTolls: settings.avoidTolls,
      avoidBorders: settings.avoidBorders,
      scenicMode: settings.scenicMode,
      routePreference: settings.routePreference,
      stopFrequency: settings.stopFrequency,
      gasPrice: settings.gasPrice,
      hotelPricePerNight: settings.hotelPricePerNight,
      mealPricePerDay: settings.mealPricePerDay,
    },

    vehicle: journal.vehicle,

    importInstructions: 'Load this template in My Experience Engine to follow the same route!',
  };

  const dataBlob = new Blob([JSON.stringify(template, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(dataBlob);
  const link = document.createElement('a');
  link.href = url;
  link.download = `trip-template-${journal.metadata.title.replace(/\s+/g, '-').toLowerCase()}.json`;
  link.click();
  URL.revokeObjectURL(url);

  showToast({
    message: 'Trip template downloaded! Share it so others can follow your route.',
    type: 'success',
    duration: 4000,
  });
}
